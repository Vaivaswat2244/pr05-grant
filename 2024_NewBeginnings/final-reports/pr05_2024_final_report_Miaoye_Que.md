
# Revamp the Friendly Error System in p5.js 2.0

| **Project** | [Revamp the Friendly Error System in p5.js 2.0](https://github.com/processing/pr05-grant/wiki/Revamp-the-Friendly-Error-System-(FES)-for-p5.js-2.0-(detailed-description)) | 
| :--- | :--- |
| **Grantee** | [Miaoye Que](https://github.com/sproutleaf) |
| **Mentors** | [Kenneth Lim](https://github.com/limzykenneth), [Dave Pagurek](https://github.com/davepagurek) |
| **Repo**| https://github.com/processing/p5.js/tree/dev-2.0 |

## Technical Decisions

### Condensing `parameterData.json` for Parameter Validation

- The existing `parameterData.json` file that we use to extract parameter information has a few problems:
  - It often contains unnecessary information, such as the function's return type.
  - It contains information that can be represented in a more concise manner, `?` at the end of the parameter name to indicate that the parameter is optional.
  - Has a nested structure that makes it difficult to parse.
- The improved `parameterData.json` file, generated by `utils/convert.js`, resolves the above issues and saw a reduction of 80% in file size.

### [Zod](https://zod.dev/) for Parameter Validation

- Zod is a powerful, flexible schema validation library withs static type inference. It provides all the use cases that parameter validation in p5.js requires.
- Zod is [already used in the p5.js ecosystem](https://github.com/processing/p5.js-website/blob/main/src/content/tutorials/config.ts#L19)â€”in the process of building p5's website.
- Zod is tree-shakable, meaning that unused library code will not be included in the final p5 bundle size.
- **Do note that** initially, we considered generating `.d.ts` files from the library code, then using the generated files as input in `ts-to-zod`, which will conveniently generate Zod schemas that can be readily used for parameter validation. However, this approach presented a few challenges, including:
  - The generated `.d.ts` files were too big and had duplicated information.
  - Chainable methods return an interface for the whole p5 module, instead of just referencing the existing p5 type.
  - Even with the `.d.ts` files generated, `ts-to-zod` [might not support all the JSDoc tags](https://github.com/processing/p5.js/pull/6972).
- As a result, we wrote custom logic that parses the `parameterData.json` file containing all the function signatures for parameter validation.
- We also experimented with using [`zod-validation-error`](https://github.com/causaly/zod-validation-error) to generate error messages, but eventually did not move forward with it because the library has a narrow range of customization options, limiting our ability to present error messages that are accessible, informative, and beginner-friendly.

### `acorn` and `acorn-walk` for detecting accidentally overriden constants and functions

- We evaluated multiple JavaScript parsers, including `acorn`, `esprima`, and `espree`, and ultimately decided to use `acorn` and `acorn-walk` because:
  - `acorn` has a smaller bundle size and is faster than `esprima`.
  - `acorn` has better support for ES2015+ syntax.
  - `acorn-walk` has a simpler API and is easier to understand and modify.
  - Both `acorn` and `acorn-walk` are tree-shakable.

## Challenges

### Achieving a balance between leveraging on external libraries and keeping FES well-built and accessible

- `ts-to-zod` and `zod-validation-error` were both great libraries that we considered using, but had to give up after some exploration due to their incompatibility with our project goals.

### Developing FES within the new p5.js 2.0 architecture

- Many new facets of the p5.js 2.0 architecture (dependency injection, decorator pattern, etc) were unfamiliar to me, and some trial-and-error was needed to understand how to implement the 2 priorities in the project properly and efficiently, which delayed the initial project timeline.

### Ensuring comprehensive coverage of use cases

- Both parameter validation and accidental override detection have many use and edge cases. Working on the development of these features required a detail-oriented attitude, and a robust understanding of FES. I made sure to document all the things to note, and worked through them diligently.

## Tasks Completed

- [x] Condensed `parameterData.json` for parameter validation
- [x] Implemented parameter validation with Zod
- [x] Implemented accidental override detection
- [x] Wrote unit tests for both parameter validation and accidental override detection

## Limitations

As of now, the two features have not been integrated into the dev-2.0 branch in p5's repo yet, meaning that old versions are still being used. There also needs to be more testing in real environments (p5.js editor, processing, etc) to ensure that they work as expected in real-world scenarios.

## Work Remaining & Next Steps

- [ ] Address the comments in the [last PR](https://github.com/processing/p5.js/pull/7326), and merge it.
- [ ] Add more robust loading of user scripts.
- [ ] Use the decorator pattern to integrate the two features into p5.js 2.0.
- [ ] Clean up old code that's no longer being used.
- [ ] Go through all open issues in p5 repo related to FES, and respond to them if this project can address them.

## Relevant PRs and Issues

Please refer to the two master issues for all PRs I've created, other issues that mention parameter validation / accidental override detection, and additional notes and to-do lists:

- [Parameter Validation](https://github.com/processing/p5.js/issues/7178)
- [Accidental Override Detection](https://github.com/processing/p5.js/issues/7269)